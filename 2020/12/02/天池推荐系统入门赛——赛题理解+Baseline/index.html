<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>天池推荐系统入门赛——赛题理解+Baseline | CYYcosmos</title><meta name="author" content="Yanyu Chen"><meta name="copyright" content="Yanyu Chen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="# 赛题理解 赛题理解是切入一道赛题的基础，会影响后续特征工程和模型构建等各种工作，也影响着后续发展工作的方向，正确了解赛题背后的思想以及赛题业务逻辑的清晰，有利于花费更少时间构建更为有效的特征模型， 在各种比赛中， 赛题理解都是极其重要且必须走好的第一步， 今天我们就从赛题的理解出发， 首先了解一下这次赛题的概况和数据，从中分析赛题以及大致的处理方式， 其次我们了解模型评测的指标，最后对赛题的">
<meta property="og:type" content="article">
<meta property="og:title" content="天池推荐系统入门赛——赛题理解+Baseline">
<meta property="og:url" content="http://cyy0214.github.io/2020/12/02/%E5%A4%A9%E6%B1%A0%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8%E8%B5%9B%E2%80%94%E2%80%94%E8%B5%9B%E9%A2%98%E7%90%86%E8%A7%A3+Baseline/index.html">
<meta property="og:site_name" content="CYYcosmos">
<meta property="og:description" content="# 赛题理解 赛题理解是切入一道赛题的基础，会影响后续特征工程和模型构建等各种工作，也影响着后续发展工作的方向，正确了解赛题背后的思想以及赛题业务逻辑的清晰，有利于花费更少时间构建更为有效的特征模型， 在各种比赛中， 赛题理解都是极其重要且必须走好的第一步， 今天我们就从赛题的理解出发， 首先了解一下这次赛题的概况和数据，从中分析赛题以及大致的处理方式， 其次我们了解模型评测的指标，最后对赛题的">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-12-02T11:10:19.000Z">
<meta property="article:modified_time" content="2020-12-06T03:25:59.466Z">
<meta property="article:author" content="Yanyu Chen">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/3.jpg"><link rel="canonical" href="http://cyy0214.github.io/2020/12/02/%E5%A4%A9%E6%B1%A0%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8%E8%B5%9B%E2%80%94%E2%80%94%E8%B5%9B%E9%A2%98%E7%90%86%E8%A7%A3+Baseline/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2020-12-06 11:25:59'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/3.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">6</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">2</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">1</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/8.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">CYYcosmos</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">天池推荐系统入门赛——赛题理解+Baseline</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-12-02T11:10:19.000Z" title="Created 2020-12-02 19:10:19">2020-12-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2020-12-06T03:25:59.466Z" title="Updated 2020-12-06 11:25:59">2020-12-06</time></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>﻿# 赛题理解</p>
<p>赛题理解是切入一道赛题的基础，会影响后续特征工程和模型构建等各种工作，也影响着后续发展工作的方向，正确了解赛题背后的思想以及赛题业务逻辑的清晰，有利于花费更少时间构建更为有效的特征模型， 在各种比赛中， 赛题理解都是极其重要且必须走好的第一步， 今天我们就从赛题的理解出发， 首先了解一下这次赛题的概况和数据，从中分析赛题以及大致的处理方式， 其次我们了解模型评测的指标，最后对赛题的理解整理一些经验。</p>
<h2 id="赛题简介"><a href="#赛题简介" class="headerlink" title="赛题简介"></a>赛题简介</h2><p>此次比赛是新闻推荐场景下的用户行为预测挑战赛， 该赛题是以新闻APP中的新闻推荐为背景， 目的是<strong>要求我们根据用户历史浏览点击新闻文章的数据信息预测用户未来的点击行为， 即用户的最后一次点击的新闻文章</strong>， 这道赛题的设计初衷是引导大家了解推荐系统中的一些业务背景， 解决实际问题。 </p>
<h2 id="数据概况"><a href="#数据概况" class="headerlink" title="数据概况"></a>数据概况</h2><p>该数据来自某新闻APP平台的用户交互数据，包括30万用户，近300万次点击，共36万多篇不同的新闻文章，同时每篇新闻文章有对应的embedding向量表示。为了保证比赛的公平性，从中抽取20万用户的点击日志数据作为训练集，5万用户的点击日志数据作为测试集A，5万用户的点击日志数据作为测试集B。具体数据表和参数， 大家可以参考赛题说明。下面说一下拿到这样的数据如何进行理解， 来有效的开展下一步的工作。</p>
<h2 id="评价方式理解"><a href="#评价方式理解" class="headerlink" title="评价方式理解"></a>评价方式理解</h2><p>理解评价方式， 我们需要结合着最后的提交文件来看， 根据sample.submit.csv， 我们最后提交的格式是针对每个用户， 我们都会给出五篇文章的推荐结果，按照点击概率从前往后排序。 而真实的每个用户最后一次点击的文章只会有一篇的真实答案， 所以我们就看我们推荐的这五篇里面是否有命中真实答案的。比如对于user1来说， 我们的提交会是：</p>
<blockquote>
<p>user1, article1, article2, article3, article4, article5.</p>
</blockquote>
<p>评价指标的公式如下：<br>$$<br>score(user) = \sum_{k=1}^5 \frac{s(user, k)}{k}<br>$$</p>
<p>假如article1就是真实的用户点击文章，也就是article1命中， 则s(user1,1)=1, s(user1,2-4)都是0， 如果article2是用户点击的文章， 则s(user,2)=1/2,s(user,1,3,4,5)都是0。也就是score(user)=命中第几条的倒数。如果都没中， 则score(user1)=0。 这个是合理的， 因为我们希望的就是命中的结果尽量靠前， 而此时分数正好比较高。</p>
<h2 id="赛题理解"><a href="#赛题理解" class="headerlink" title="赛题理解"></a>赛题理解</h2><p>根据赛题简介，我们首先要明确我们此次比赛的目标： 根据用户历史浏览点击新闻的数据信息预测用户最后一次点击的新闻文章。从这个目标上看， 会发现此次比赛和我们之前遇到的普通的结构化比赛不太一样， 主要有两点：</p>
<ul>
<li>首先是目标上， 要预测最后一次点击的新闻文章，也就是我们给用户推荐的是新闻文章， 并不是像之前那种预测一个数或者预测数据哪一类那样的问题</li>
<li>数据上， 通过给出的数据我们会发现， 这种数据也不是我们之前遇到的那种特征+标签的数据，而是基于了真实的业务场景， 拿到的用户的点击日志</li>
</ul>
<p>所以拿到这个题目，我们的思考方向就是结合我们的目标，<strong>把该预测问题转成一个监督学习的问题(特征+标签)，然后我们才能进行ML，DL等建模预测</strong>。那么我们自然而然的就应该在心里会有这么几个问题：如何转成一个监督学习问题呢？ 转成一个什么样的监督学习问题呢？ 我们能利用的特征又有哪些呢？ 又有哪些模型可以尝试呢？ 此次面对数万级别的文章推荐，我们又有哪些策略呢？ </p>
<p>当然这些问题不会在我们刚看到赛题之后就一下出来答案， 但是只要有了问题之后， 我们就能想办法解决问题了， 比如上面的第二个问题，转成一个什么样的监督学习问题？  由于我们是预测用户最后一次点击的新闻文章，从36万篇文章中预测某一篇的话我们首先可能会想到这可能是一个多分类的问题(36万类里面选1)， 但是如此庞大的分类问题， 我们做起来可能比较困难， 那么能不能转化一下？ 既然是要预测最后一次点击的文章， 那么如果我们能预测出某个用户最后一次对于某一篇文章会进行点击的概率， 是不是就间接性的解决了这个问题呢？概率最大的那篇文章不就是用户最后一次可能点击的新闻文章吗？ 这样就把原问题变成了一个点击率预测的问题(用户, 文章) –&gt; 点击的概率(软分类)， 而这个问题， 就是我们所熟悉的监督学习领域分类问题了， 这样我们后面建模的时候， 对于模型的选择就基本上有大致方向了，比如最简单的逻辑回归模型。</p>
<p>这样， 我们对于该赛题的解决方案应该有了一个大致的解决思路，要先转成一个分类问题来做， 而分类的标签就是用户是否会点击某篇文章，分类问题的特征中会有用户和文章，我们要训练一个分类模型， 对某用户最后一次点击某篇文章的概率进行预测。 那么又会有几个问题：如何转成监督学习问题？ 训练集和测试集怎么制作？ 我们又能利用哪些特征？ 我们又可以尝试哪些模型？ 面对36万篇文章， 20多万用户的推荐， 我们又有哪些策略来缩减问题的规模？如何进行最后的预测？  </p>
<h1 id="Baseline"><a href="#Baseline" class="headerlink" title="Baseline"></a>Baseline</h1><h2 id="导包"><a href="#导包" class="headerlink" title="导包"></a>导包</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># import packages</span></span><br><span class="line"><span class="keyword">import</span> time, math, os</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> gc</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> operator <span class="keyword">import</span> itemgetter</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line">warnings.filterwarnings(<span class="string">&#x27;ignore&#x27;</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data_path = <span class="string">&#x27;./data_raw/&#x27;</span></span><br><span class="line">save_path = <span class="string">&#x27;./tmp_results/&#x27;</span></span><br></pre></td></tr></table></figure>



<h2 id="df节省内存函数"><a href="#df节省内存函数" class="headerlink" title="df节省内存函数"></a>df节省内存函数</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 节约内存的一个标配函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reduce_mem</span>(<span class="params">df</span>):</span></span><br><span class="line">    starttime = time.time()</span><br><span class="line">    numerics = [<span class="string">&#x27;int16&#x27;</span>, <span class="string">&#x27;int32&#x27;</span>, <span class="string">&#x27;int64&#x27;</span>, <span class="string">&#x27;float16&#x27;</span>, <span class="string">&#x27;float32&#x27;</span>, <span class="string">&#x27;float64&#x27;</span>]</span><br><span class="line">    start_mem = df.memory_usage().<span class="built_in">sum</span>() / <span class="number">1024</span>**<span class="number">2</span></span><br><span class="line">    <span class="keyword">for</span> col <span class="keyword">in</span> df.columns:</span><br><span class="line">        col_type = df[col].dtypes</span><br><span class="line">        <span class="keyword">if</span> col_type <span class="keyword">in</span> numerics:</span><br><span class="line">            c_min = df[col].<span class="built_in">min</span>()</span><br><span class="line">            c_max = df[col].<span class="built_in">max</span>()</span><br><span class="line">            <span class="keyword">if</span> pd.isnull(c_min) <span class="keyword">or</span> pd.isnull(c_max):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">str</span>(col_type)[:<span class="number">3</span>] == <span class="string">&#x27;int&#x27;</span>:</span><br><span class="line">                <span class="keyword">if</span> c_min &gt; np.iinfo(np.int8).<span class="built_in">min</span> <span class="keyword">and</span> c_max &lt; np.iinfo(np.int8).<span class="built_in">max</span>:</span><br><span class="line">                    df[col] = df[col].astype(np.int8)</span><br><span class="line">                <span class="keyword">elif</span> c_min &gt; np.iinfo(np.int16).<span class="built_in">min</span> <span class="keyword">and</span> c_max &lt; np.iinfo(np.int16).<span class="built_in">max</span>:</span><br><span class="line">                    df[col] = df[col].astype(np.int16)</span><br><span class="line">                <span class="keyword">elif</span> c_min &gt; np.iinfo(np.int32).<span class="built_in">min</span> <span class="keyword">and</span> c_max &lt; np.iinfo(np.int32).<span class="built_in">max</span>:</span><br><span class="line">                    df[col] = df[col].astype(np.int32)</span><br><span class="line">                <span class="keyword">elif</span> c_min &gt; np.iinfo(np.int64).<span class="built_in">min</span> <span class="keyword">and</span> c_max &lt; np.iinfo(np.int64).<span class="built_in">max</span>:</span><br><span class="line">                    df[col] = df[col].astype(np.int64)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> c_min &gt; np.finfo(np.float16).<span class="built_in">min</span> <span class="keyword">and</span> c_max &lt; np.finfo(np.float16).<span class="built_in">max</span>:</span><br><span class="line">                    df[col] = df[col].astype(np.float16)</span><br><span class="line">                <span class="keyword">elif</span> c_min &gt; np.finfo(np.float32).<span class="built_in">min</span> <span class="keyword">and</span> c_max &lt; np.finfo(np.float32).<span class="built_in">max</span>:</span><br><span class="line">                    df[col] = df[col].astype(np.float32)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    df[col] = df[col].astype(np.float64)</span><br><span class="line">    end_mem = df.memory_usage().<span class="built_in">sum</span>() / <span class="number">1024</span>**<span class="number">2</span></span><br><span class="line">    print(<span class="string">&#x27;-- Mem. usage decreased to &#123;:5.2f&#125; Mb (&#123;:.1f&#125;% reduction),time spend:&#123;:2.2f&#125; min&#x27;</span>.<span class="built_in">format</span>(end_mem,</span><br><span class="line">                                                                                                           <span class="number">100</span>*(start_mem-end_mem)/start_mem,</span><br><span class="line">                                                                                                           (time.time()-starttime)/<span class="number">60</span>))</span><br><span class="line">    <span class="keyword">return</span> df</span><br></pre></td></tr></table></figure>



<h2 id="读取采样或全量数据"><a href="#读取采样或全量数据" class="headerlink" title="读取采样或全量数据"></a>读取采样或全量数据</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># debug模式：从训练集中划出一部分数据来调试代码</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_all_click_sample</span>(<span class="params">data_path, sample_nums=<span class="number">10000</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        训练集中采样一部分数据调试</span></span><br><span class="line"><span class="string">        data_path: 原数据的存储路径</span></span><br><span class="line"><span class="string">        sample_nums: 采样数目（这里由于机器的内存限制，可以采样用户做）</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    all_click = pd.read_csv(data_path + <span class="string">&#x27;train_click_log.csv&#x27;</span>)</span><br><span class="line">    all_user_ids = all_click.user_id.unique()</span><br><span class="line"></span><br><span class="line">    sample_user_ids = np.random.choice(all_user_ids, size=sample_nums, replace=<span class="literal">False</span>) </span><br><span class="line">    all_click = all_click[all_click[<span class="string">&#x27;user_id&#x27;</span>].isin(sample_user_ids)]</span><br><span class="line">    </span><br><span class="line">    all_click = all_click.drop_duplicates(([<span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;click_article_id&#x27;</span>, <span class="string">&#x27;click_timestamp&#x27;</span>]))</span><br><span class="line">    <span class="keyword">return</span> all_click</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取点击数据，这里分成线上和线下，如果是为了获取线上提交结果应该讲测试集中的点击数据合并到总的数据中</span></span><br><span class="line"><span class="comment"># 如果是为了线下验证模型的有效性或者特征的有效性，可以只使用训练集</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_all_click_df</span>(<span class="params">data_path=<span class="string">&#x27;./data_raw/&#x27;</span>, offline=<span class="literal">True</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> offline:</span><br><span class="line">        all_click = pd.read_csv(data_path + <span class="string">&#x27;train_click_log.csv&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        trn_click = pd.read_csv(data_path + <span class="string">&#x27;train_click_log.csv&#x27;</span>)</span><br><span class="line">        tst_click = pd.read_csv(data_path + <span class="string">&#x27;testA_click_log.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        all_click = trn_click.append(tst_click)</span><br><span class="line">    </span><br><span class="line">    all_click = all_click.drop_duplicates(([<span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;click_article_id&#x27;</span>, <span class="string">&#x27;click_timestamp&#x27;</span>]))</span><br><span class="line">    <span class="keyword">return</span> all_click</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全量训练集</span></span><br><span class="line">all_click_df = get_all_click_df(offline=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>



<h2 id="获取-用户-文章-点击时间字典"><a href="#获取-用户-文章-点击时间字典" class="headerlink" title="获取 用户 - 文章 - 点击时间字典"></a>获取 用户 - 文章 - 点击时间字典</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据点击时间获取用户的点击文章序列   &#123;user1: &#123;item1: time1, item2: time2..&#125;...&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user_item_time</span>(<span class="params">click_df</span>):</span></span><br><span class="line">    </span><br><span class="line">    click_df = click_df.sort_values(<span class="string">&#x27;click_timestamp&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">make_item_time_pair</span>(<span class="params">df</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">list</span>(<span class="built_in">zip</span>(df[<span class="string">&#x27;click_article_id&#x27;</span>], df[<span class="string">&#x27;click_timestamp&#x27;</span>]))</span><br><span class="line">    </span><br><span class="line">    user_item_time_df = click_df.groupby(<span class="string">&#x27;user_id&#x27;</span>)[<span class="string">&#x27;click_article_id&#x27;</span>, <span class="string">&#x27;click_timestamp&#x27;</span>].apply(<span class="keyword">lambda</span> x: make_item_time_pair(x))\</span><br><span class="line">                                                            .reset_index().rename(columns=&#123;<span class="number">0</span>: <span class="string">&#x27;item_time_list&#x27;</span>&#125;)</span><br><span class="line">    user_item_time_dict = <span class="built_in">dict</span>(<span class="built_in">zip</span>(user_item_time_df[<span class="string">&#x27;user_id&#x27;</span>], user_item_time_df[<span class="string">&#x27;item_time_list&#x27;</span>]))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> user_item_time_dict</span><br></pre></td></tr></table></figure>



<h2 id="获取点击最多的Topk个文章"><a href="#获取点击最多的Topk个文章" class="headerlink" title="获取点击最多的Topk个文章"></a>获取点击最多的Topk个文章</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取近期点击最多的文章</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_item_topk_click</span>(<span class="params">click_df, k</span>):</span></span><br><span class="line">    topk_click = click_df[<span class="string">&#x27;click_article_id&#x27;</span>].value_counts().index[:k]</span><br><span class="line">    <span class="keyword">return</span> topk_click</span><br></pre></td></tr></table></figure>



<h2 id="itemCF的物品相似度计算"><a href="#itemCF的物品相似度计算" class="headerlink" title="itemCF的物品相似度计算"></a>itemCF的物品相似度计算</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">itemcf_sim</span>(<span class="params">df</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        文章与文章之间的相似性矩阵计算</span></span><br><span class="line"><span class="string">        :param df: 数据表</span></span><br><span class="line"><span class="string">        :item_created_time_dict:  文章创建时间的字典</span></span><br><span class="line"><span class="string">        return : 文章与文章的相似性矩阵</span></span><br><span class="line"><span class="string">        思路: 基于物品的协同过滤(详细请参考上一期推荐系统基础的组队学习)， 在多路召回部分会加上关联规则的召回策略</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    user_item_time_dict = get_user_item_time(df)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 计算物品相似度</span></span><br><span class="line">    i2i_sim = &#123;&#125;</span><br><span class="line">    item_cnt = defaultdict(<span class="built_in">int</span>)</span><br><span class="line">    <span class="keyword">for</span> user, item_time_list <span class="keyword">in</span> tqdm(user_item_time_dict.items()):</span><br><span class="line">        <span class="comment"># 在基于商品的协同过滤优化的时候可以考虑时间因素</span></span><br><span class="line">        <span class="keyword">for</span> i, i_click_time <span class="keyword">in</span> item_time_list:</span><br><span class="line">            item_cnt[i] += <span class="number">1</span></span><br><span class="line">            i2i_sim.setdefault(i, &#123;&#125;)</span><br><span class="line">            <span class="keyword">for</span> j, j_click_time <span class="keyword">in</span> item_time_list:</span><br><span class="line">                <span class="keyword">if</span>(i == j):</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                i2i_sim[i].setdefault(j, <span class="number">0</span>)</span><br><span class="line">                </span><br><span class="line">                i2i_sim[i][j] += <span class="number">1</span> / math.log(<span class="built_in">len</span>(item_time_list) + <span class="number">1</span>)</span><br><span class="line">                </span><br><span class="line">    i2i_sim_ = i2i_sim.copy()</span><br><span class="line">    <span class="keyword">for</span> i, related_items <span class="keyword">in</span> i2i_sim.items():</span><br><span class="line">        <span class="keyword">for</span> j, wij <span class="keyword">in</span> related_items.items():</span><br><span class="line">            i2i_sim_[i][j] = wij / math.sqrt(item_cnt[i] * item_cnt[j])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将得到的相似性矩阵保存到本地</span></span><br><span class="line">    pickle.dump(i2i_sim_, <span class="built_in">open</span>(save_path + <span class="string">&#x27;itemcf_i2i_sim.pkl&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> i2i_sim_</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i2i_sim = itemcf_sim(all_click_df)</span><br></pre></td></tr></table></figure>



<h2 id="itemCF-的文章推荐"><a href="#itemCF-的文章推荐" class="headerlink" title="itemCF 的文章推荐"></a>itemCF 的文章推荐</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基于商品的召回i2i</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">item_based_recommend</span>(<span class="params">user_id, user_item_time_dict, i2i_sim, sim_item_topk, recall_item_num, item_topk_click</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        基于文章协同过滤的召回</span></span><br><span class="line"><span class="string">        :param user_id: 用户id</span></span><br><span class="line"><span class="string">        :param user_item_time_dict: 字典, 根据点击时间获取用户的点击文章序列   &#123;user1: &#123;item1: time1, item2: time2..&#125;...&#125;</span></span><br><span class="line"><span class="string">        :param i2i_sim: 字典，文章相似性矩阵</span></span><br><span class="line"><span class="string">        :param sim_item_topk: 整数， 选择与当前文章最相似的前k篇文章</span></span><br><span class="line"><span class="string">        :param recall_item_num: 整数， 最后的召回文章数量</span></span><br><span class="line"><span class="string">        :param item_topk_click: 列表，点击次数最多的文章列表，用户召回补全        </span></span><br><span class="line"><span class="string">        return: 召回的文章列表 &#123;item1:score1, item2: score2...&#125;</span></span><br><span class="line"><span class="string">        注意: 基于物品的协同过滤(详细请参考上一期推荐系统基础的组队学习)， 在多路召回部分会加上关联规则的召回策略</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 获取用户历史交互的文章</span></span><br><span class="line">    user_hist_items = user_item_time_dict[user_id]</span><br><span class="line">    </span><br><span class="line">    item_rank = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> loc, (i, click_time) <span class="keyword">in</span> <span class="built_in">enumerate</span>(user_hist_items):</span><br><span class="line">        <span class="keyword">for</span> j, wij <span class="keyword">in</span> <span class="built_in">sorted</span>(i2i_sim[i].items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)[:sim_item_topk]:</span><br><span class="line">            <span class="keyword">if</span> j <span class="keyword">in</span> user_hist_items:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">            item_rank.setdefault(j, <span class="number">0</span>)</span><br><span class="line">            item_rank[j] +=  wij</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 不足10个，用热门商品补全</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(item_rank) &lt; recall_item_num:</span><br><span class="line">        <span class="keyword">for</span> i, item <span class="keyword">in</span> <span class="built_in">enumerate</span>(item_topk_click):</span><br><span class="line">            <span class="keyword">if</span> item <span class="keyword">in</span> item_rank.items(): <span class="comment"># 填充的item应该不在原来的列表中</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            item_rank[item] = - i - <span class="number">100</span> <span class="comment"># 随便给个负数就行</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(item_rank) == recall_item_num:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    item_rank = <span class="built_in">sorted</span>(item_rank.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)[:recall_item_num]</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> item_rank</span><br></pre></td></tr></table></figure>



<h2 id="给每个用户根据物品的协同过滤推荐文章"><a href="#给每个用户根据物品的协同过滤推荐文章" class="headerlink" title="给每个用户根据物品的协同过滤推荐文章"></a>给每个用户根据物品的协同过滤推荐文章</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义</span></span><br><span class="line">user_recall_items_dict = collections.defaultdict(<span class="built_in">dict</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 用户 - 文章 - 点击时间的字典</span></span><br><span class="line">user_item_time_dict = get_user_item_time(all_click_df)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 去取文章相似度</span></span><br><span class="line">i2i_sim = pickle.load(<span class="built_in">open</span>(save_path + <span class="string">&#x27;itemcf_i2i_sim.pkl&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 相似文章的数量</span></span><br><span class="line">sim_item_topk = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 召回文章数量</span></span><br><span class="line">recall_item_num = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户热度补全</span></span><br><span class="line">item_topk_click = get_item_topk_click(all_click_df, k=<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> tqdm(all_click_df[<span class="string">&#x27;user_id&#x27;</span>].unique()):</span><br><span class="line">    user_recall_items_dict[user] = item_based_recommend(user, user_item_time_dict, i2i_sim, </span><br><span class="line">                                                        sim_item_topk, recall_item_num, item_topk_click)</span><br></pre></td></tr></table></figure>



<h2 id="召回字典转换成df"><a href="#召回字典转换成df" class="headerlink" title="召回字典转换成df"></a>召回字典转换成df</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将字典的形式转换成df</span></span><br><span class="line">user_item_score_list = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> user, items <span class="keyword">in</span> tqdm(user_recall_items_dict.items()):</span><br><span class="line">    <span class="keyword">for</span> item, score <span class="keyword">in</span> items:</span><br><span class="line">        user_item_score_list.append([user, item, score])</span><br><span class="line"></span><br><span class="line">recall_df = pd.DataFrame(user_item_score_list, columns=[<span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;click_article_id&#x27;</span>, <span class="string">&#x27;pred_score&#x27;</span>])</span><br></pre></td></tr></table></figure>



<h2 id="生成提交文件"><a href="#生成提交文件" class="headerlink" title="生成提交文件"></a>生成提交文件</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成提交文件</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">submit</span>(<span class="params">recall_df, topk=<span class="number">5</span>, model_name=<span class="literal">None</span></span>):</span></span><br><span class="line">    recall_df = recall_df.sort_values(by=[<span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;pred_score&#x27;</span>])</span><br><span class="line">    recall_df[<span class="string">&#x27;rank&#x27;</span>] = recall_df.groupby([<span class="string">&#x27;user_id&#x27;</span>])[<span class="string">&#x27;pred_score&#x27;</span>].rank(ascending=<span class="literal">False</span>, method=<span class="string">&#x27;first&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 判断是不是每个用户都有5篇文章及以上</span></span><br><span class="line">    tmp = recall_df.groupby(<span class="string">&#x27;user_id&#x27;</span>).apply(<span class="keyword">lambda</span> x: x[<span class="string">&#x27;rank&#x27;</span>].<span class="built_in">max</span>())</span><br><span class="line">    <span class="keyword">assert</span> tmp.<span class="built_in">min</span>() &gt;= topk</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">del</span> recall_df[<span class="string">&#x27;pred_score&#x27;</span>]</span><br><span class="line">    submit = recall_df[recall_df[<span class="string">&#x27;rank&#x27;</span>] &lt;= topk].set_index([<span class="string">&#x27;user_id&#x27;</span>, <span class="string">&#x27;rank&#x27;</span>]).unstack(-<span class="number">1</span>).reset_index()</span><br><span class="line">    </span><br><span class="line">    submit.columns = [<span class="built_in">int</span>(col) <span class="keyword">if</span> <span class="built_in">isinstance</span>(col, <span class="built_in">int</span>) <span class="keyword">else</span> col <span class="keyword">for</span> col <span class="keyword">in</span> submit.columns.droplevel(<span class="number">0</span>)]</span><br><span class="line">    <span class="comment"># 按照提交格式定义列名</span></span><br><span class="line">    submit = submit.rename(columns=&#123;<span class="string">&#x27;&#x27;</span>: <span class="string">&#x27;user_id&#x27;</span>, <span class="number">1</span>: <span class="string">&#x27;article_1&#x27;</span>, <span class="number">2</span>: <span class="string">&#x27;article_2&#x27;</span>, </span><br><span class="line">                                                  <span class="number">3</span>: <span class="string">&#x27;article_3&#x27;</span>, <span class="number">4</span>: <span class="string">&#x27;article_4&#x27;</span>, <span class="number">5</span>: <span class="string">&#x27;article_5&#x27;</span>&#125;)</span><br><span class="line">    </span><br><span class="line">    save_name = save_path + model_name + <span class="string">&#x27;_&#x27;</span> + datetime.today().strftime(<span class="string">&#x27;%m-%d&#x27;</span>) + <span class="string">&#x27;.csv&#x27;</span></span><br><span class="line">    submit.to_csv(save_name, index=<span class="literal">False</span>, header=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取测试集</span></span><br><span class="line">tst_click = pd.read_csv(data_path + <span class="string">&#x27;testA_click_log.csv&#x27;</span>)</span><br><span class="line">tst_users = tst_click[<span class="string">&#x27;user_id&#x27;</span>].unique()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从所有的召回数据中将测试集中的用户选出来</span></span><br><span class="line">tst_recall = recall_df[recall_df[<span class="string">&#x27;user_id&#x27;</span>].isin(tst_users)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成提交文件</span></span><br><span class="line">submit(tst_recall, topk=<span class="number">5</span>, model_name=<span class="string">&#x27;itemcf_baseline&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本节内容主要包括赛题简介，数据概况，评价方式以及对该赛题进行了一个总体上的思路分析，作为竞赛前的预热，旨在帮助学习者们能够更好切入该赛题，为后面的学习内容打下一个良好的基础。最后我们给出了关于本赛题的一个简易Baseline， 帮助学习者们先了解一下新闻推荐比赛的一个整理流程， 接下来我们就对于流程中的每个步骤进行详细的介绍。</p>
<p>今天的学习比较简单，下面整理一下关于赛题理解的一些经验：</p>
<ul>
<li>赛题理解究竟是在理解什么? </li>
</ul>
<blockquote>
<p><strong>理解赛题</strong>：从直观上对问题进行梳理， 分析问题的目标，到底要让做什么事情, <strong>这个非常重要</strong></p>
<p><strong>理解数据</strong>：对赛题数据有一个初步了解，知道和任务相关的数据字段和数据字段的类型， 数据之间的内在关联等，大体梳理一下哪些数据会对我们解决问题非常有用，方便后面我们的数据分析和特征工程。</p>
<p><strong>理解评估指标</strong>：评估指标是检验我们提出的方法，我们给出结果好坏的标准，只有正确的理解了评估指标，我们才能进行更好的训练模型，更好的进行预测。此外，很多情况下，线上验证是有一定的时间和次数限制的，<strong>所以在比赛中构建一个合理的本地的验证集和验证的评价指标是很关键的步骤，能有效的节省很多时间</strong>。 不同的指标对于同样的预测结果是具有误差敏感的差异性的所以不同的评价指标会影响后续一些预测的侧重点。</p>
</blockquote>
<ul>
<li><p>有了赛题理解之后，我们该做什么？</p>
<blockquote>
<p>在对于赛题有了一定的了解后，分析清楚了问题的类型性质和对于数据理解 的这一基础上，我们可以梳理一个解决赛题的一个大题思路和框架</p>
<p>我们至少要有一些相应的理解分析，比如<strong>这题的难点可能在哪里，关键点可能在哪里，哪些地方可以挖掘更好的特征</strong>.</p>
<p>用什么样得线下验证方式更为稳定，<strong>出现了过拟合或者其他问题，估摸可以用什么方法去解决这些问题</strong></p>
</blockquote>
<p>这时是在一个宏观的大体下分析的，有助于摸清整个题的思路脉络，以及后续的分析方向</p>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Yanyu Chen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://cyy0214.github.io/2020/12/02/%E5%A4%A9%E6%B1%A0%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8%E8%B5%9B%E2%80%94%E2%80%94%E8%B5%9B%E9%A2%98%E7%90%86%E8%A7%A3+Baseline/">http://cyy0214.github.io/2020/12/02/%E5%A4%A9%E6%B1%A0%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8%E8%B5%9B%E2%80%94%E2%80%94%E8%B5%9B%E9%A2%98%E7%90%86%E8%A7%A3+Baseline/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/02/%E5%A4%A9%E6%B1%A0%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8%E8%B5%9B%E2%80%94%E2%80%94%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">天池推荐系统入门赛——数据分析</div></div></a></div><div class="next-post pull-right"><a href="/2020/07/28/%E3%80%90%E7%89%B9%E5%BE%81%E6%8F%90%E5%8F%96+%E5%88%86%E7%B1%BB%E6%A8%A1%E5%9E%8B%E3%80%914%E7%A7%8D%E5%B8%B8%E8%A7%81%E7%9A%84NLP%E5%AE%9E%E8%B7%B5%E6%80%9D%E8%B7%AF/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">【特征提取+分类模型】4种常见的NLP实践思路</div></div></a></div></nav></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/3.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Yanyu Chen</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">6</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">2</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">1</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/cyy0214"><i class="fab fa-github"></i><span>Follow Me</span></a></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">If you have any problem, please feel free to contact with me.,E-mail：yanyu_chen_98@163.com</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%9B%E9%A2%98%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">赛题简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%A6%82%E5%86%B5"><span class="toc-number">2.</span> <span class="toc-text">数据概况</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%84%E4%BB%B7%E6%96%B9%E5%BC%8F%E7%90%86%E8%A7%A3"><span class="toc-number">3.</span> <span class="toc-text">评价方式理解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%9B%E9%A2%98%E7%90%86%E8%A7%A3"><span class="toc-number">4.</span> <span class="toc-text">赛题理解</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Baseline"><span class="toc-number"></span> <span class="toc-text">Baseline</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%BC%E5%8C%85"><span class="toc-number">1.</span> <span class="toc-text">导包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#df%E8%8A%82%E7%9C%81%E5%86%85%E5%AD%98%E5%87%BD%E6%95%B0"><span class="toc-number">2.</span> <span class="toc-text">df节省内存函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E9%87%87%E6%A0%B7%E6%88%96%E5%85%A8%E9%87%8F%E6%95%B0%E6%8D%AE"><span class="toc-number">3.</span> <span class="toc-text">读取采样或全量数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96-%E7%94%A8%E6%88%B7-%E6%96%87%E7%AB%A0-%E7%82%B9%E5%87%BB%E6%97%B6%E9%97%B4%E5%AD%97%E5%85%B8"><span class="toc-number">4.</span> <span class="toc-text">获取 用户 - 文章 - 点击时间字典</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%82%B9%E5%87%BB%E6%9C%80%E5%A4%9A%E7%9A%84Topk%E4%B8%AA%E6%96%87%E7%AB%A0"><span class="toc-number">5.</span> <span class="toc-text">获取点击最多的Topk个文章</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#itemCF%E7%9A%84%E7%89%A9%E5%93%81%E7%9B%B8%E4%BC%BC%E5%BA%A6%E8%AE%A1%E7%AE%97"><span class="toc-number">6.</span> <span class="toc-text">itemCF的物品相似度计算</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#itemCF-%E7%9A%84%E6%96%87%E7%AB%A0%E6%8E%A8%E8%8D%90"><span class="toc-number">7.</span> <span class="toc-text">itemCF 的文章推荐</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%99%E6%AF%8F%E4%B8%AA%E7%94%A8%E6%88%B7%E6%A0%B9%E6%8D%AE%E7%89%A9%E5%93%81%E7%9A%84%E5%8D%8F%E5%90%8C%E8%BF%87%E6%BB%A4%E6%8E%A8%E8%8D%90%E6%96%87%E7%AB%A0"><span class="toc-number">8.</span> <span class="toc-text">给每个用户根据物品的协同过滤推荐文章</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AC%E5%9B%9E%E5%AD%97%E5%85%B8%E8%BD%AC%E6%8D%A2%E6%88%90df"><span class="toc-number">9.</span> <span class="toc-text">召回字典转换成df</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%8F%90%E4%BA%A4%E6%96%87%E4%BB%B6"><span class="toc-number">10.</span> <span class="toc-text">生成提交文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number"></span> <span class="toc-text">总结</span></a></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2020/12/02/%E5%A4%A9%E6%B1%A0%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8%E8%B5%9B%E2%80%94%E2%80%94%E6%8E%92%E5%BA%8F%E6%A8%A1%E5%9E%8B+%E6%A8%A1%E5%9E%8B%E8%9E%8D%E5%90%88/" title="天池推荐系统入门赛——排序模型+模型融合"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="天池推荐系统入门赛——排序模型+模型融合"/></a><div class="content"><a class="title" href="/2020/12/02/%E5%A4%A9%E6%B1%A0%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8%E8%B5%9B%E2%80%94%E2%80%94%E6%8E%92%E5%BA%8F%E6%A8%A1%E5%9E%8B+%E6%A8%A1%E5%9E%8B%E8%9E%8D%E5%90%88/" title="天池推荐系统入门赛——排序模型+模型融合">天池推荐系统入门赛——排序模型+模型融合</a><time datetime="2020-12-02T11:40:19.000Z" title="Created 2020-12-02 19:40:19">2020-12-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/02/%E5%A4%A9%E6%B1%A0%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8%E8%B5%9B%E2%80%94%E2%80%94%E5%A4%9A%E8%B7%AF%E5%8F%AC%E5%9B%9E/" title="天池推荐系统入门赛——多路召回"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="天池推荐系统入门赛——多路召回"/></a><div class="content"><a class="title" href="/2020/12/02/%E5%A4%A9%E6%B1%A0%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8%E8%B5%9B%E2%80%94%E2%80%94%E5%A4%9A%E8%B7%AF%E5%8F%AC%E5%9B%9E/" title="天池推荐系统入门赛——多路召回">天池推荐系统入门赛——多路召回</a><time datetime="2020-12-02T11:35:19.000Z" title="Created 2020-12-02 19:35:19">2020-12-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/02/%E5%A4%A9%E6%B1%A0%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8%E8%B5%9B%E2%80%94%E2%80%94%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B/" title="天池推荐系统入门赛——特征工程"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="天池推荐系统入门赛——特征工程"/></a><div class="content"><a class="title" href="/2020/12/02/%E5%A4%A9%E6%B1%A0%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8%E8%B5%9B%E2%80%94%E2%80%94%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B/" title="天池推荐系统入门赛——特征工程">天池推荐系统入门赛——特征工程</a><time datetime="2020-12-02T11:20:19.000Z" title="Created 2020-12-02 19:20:19">2020-12-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/02/%E5%A4%A9%E6%B1%A0%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8%E8%B5%9B%E2%80%94%E2%80%94%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/" title="天池推荐系统入门赛——数据分析"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="天池推荐系统入门赛——数据分析"/></a><div class="content"><a class="title" href="/2020/12/02/%E5%A4%A9%E6%B1%A0%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8%E8%B5%9B%E2%80%94%E2%80%94%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/" title="天池推荐系统入门赛——数据分析">天池推荐系统入门赛——数据分析</a><time datetime="2020-12-02T11:16:19.000Z" title="Created 2020-12-02 19:16:19">2020-12-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/02/%E5%A4%A9%E6%B1%A0%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8%E8%B5%9B%E2%80%94%E2%80%94%E8%B5%9B%E9%A2%98%E7%90%86%E8%A7%A3+Baseline/" title="天池推荐系统入门赛——赛题理解+Baseline"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="天池推荐系统入门赛——赛题理解+Baseline"/></a><div class="content"><a class="title" href="/2020/12/02/%E5%A4%A9%E6%B1%A0%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%85%A5%E9%97%A8%E8%B5%9B%E2%80%94%E2%80%94%E8%B5%9B%E9%A2%98%E7%90%86%E8%A7%A3+Baseline/" title="天池推荐系统入门赛——赛题理解+Baseline">天池推荐系统入门赛——赛题理解+Baseline</a><time datetime="2020-12-02T11:10:19.000Z" title="Created 2020-12-02 19:10:19">2020-12-02</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/8.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 By Yanyu Chen</div><div class="footer_custom_text">Welcome to my blog~</div><div class="icp"><a><img class="icp-icon" src="/img/icp.png" alt="ICP"/><span></span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})</script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>